var article_array,link_target,redirection_counter=-1,debug=!0,page=0,pos_focus=0,window_status="article-list",content_arr=[],source_array=[],k=0,panels=["all"],current_panel=0,log_data=[],log=!0,activity=!1,volume_status=!1,rss_title="";$(document).ready(function(){function e(){x=localStorage.getItem("search"),b=localStorage.getItem("interval"),y=localStorage.getItem("status"),$("div#input-wrapper #search").val(x),$("div#input-wrapper #time").val(b),"true"==y?$("input[type=checkbox]").prop("checked",!0):$("input[type=checkbox]").prop("checked",!1)}function t(){var e=new Applait.Finder({type:"sdcard",debugMode:!1});e.on("empty",function(e){toaster("no sdcard found")}),e.search("rss-reader.json"),e.on("searchComplete",function(e,t){0==t&&$("#download").html("ðŸ˜´<br>No json file founded")}),e.on("fileFound",function(e,t,s){var o=new FileReader;o.onerror=function(e){toaster("shit happens"),o.abort()},o.onloadend=function(e){var t;try{t=JSON.parse(e.target.result)}catch(e){return $("#download").html("ðŸ˜´<br>Your json file is not valid"),!1}$.each(t,function(e,t){t.categorie||(t.categorie=0),source_array.push([t.url,t.limit,t.channel,t.categorie])}),navigator.onLine?a(source_array[0][0],source_array[0][1],source_array[0][2],source_array[0][3]):$("#download").html("ðŸ˜´<br>Your device is offline, please connect it to the internet ")},o.readAsText(e)})}function a(e,t,o,r){function i(){}function n(){toaster("failed"+o,1e3)}function c(e){if(""==rss_type&&!0===activity)return $("#download").html("The content is <br>not a valid rss feed <div style='font-size:2rem;margin:8px 0 0 0;color:white!Important;'>Â¯&#92;_(ãƒ„)_/Â¯</div><br>"),!1;k==source_array.length-1&&(setTimeout(()=>{s(),cache.saveCache(content_arr)},1500),!0===log&&(delete_file("rss_log.txt"),setTimeout(()=>{var e=new Date,t=e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear()+" "+e.getHours()+":"+e.getMinutes();write_file(log_data.toString()+t,"rss_log.txt")},2e3))),k<source_array.length-1&&(k++,a(source_array[k][0],source_array[k][1],source_array[k][2],source_array[k][3]))}var l=new XMLHttpRequest({mozSystem:!0});l.open("GET",e,!0),l.withCredentials=!0,l.timeout=2e3,l.setRequestHeader("Cache-control","public, max-age=31536000"),l.responseType="document",l.overrideMimeType("text/xml"),l.send(null),$("div#message-box").css("display","block"),l.addEventListener("load",i),l.addEventListener("error",n),l.addEventListener("loadend",c),l.onload=function(){if(log_data.push(["",l.staus,o,"\n"]),l.readyState===l.DONE&&200===l.status){var e=l.response;rss_type="",rss_title=$(e).find("title:first").text();let a=k+" / "+source_array.length;$("#download").html("downloading<br><br>"+rss_title),$("div#count").text(a),$(e).find("entry").each(function(e){if(rss_type="atom",e<t){var a=$(this).find("title").text(),s=$(this).find("summary").text(),i="",n="";""==s&&(s=$(this).find("media\\:description").text(),i=$(this).find("media\\:thumbnail").attr("url"),n=$(this).find("yt\\:videoId").text()),""==s&&(s=$(this).find("content").text());var c=$(this).find("link").attr("href"),l=$(this).find("enclosure").attr("url"),d=Date.parse($(this).find("updated").text());item_date=new Date(d),item_date=item_date.toGMTString();var u=$(this).find("enclosure").attr("type");content_arr.push([a,s,c,item_date,d,o,r,l,u,i,n])}}),$(e).find("item").each(function(e){if(rss_type="rss",e<t){var a=$(this).find("title").text(),s=$(this).find("description").text(),i=$(this).find("link").text(),n=Date.parse($(this).find("pubDate").text());item_date=new Date(n),item_date=item_date.toGMTString();var c=$(this).find("enclosure").attr("url"),l=$(this).find("enclosure").attr("type");content_arr.push([a,s,i,item_date,n,o,r,c,l])}})}404===l.status&&(toaster(o+" url not found",3e3),log_data.push(["url not found",l.staus,o,"\n"])),408===l.status&&(toaster(o+"Time out",3e3),log_data.push(["timeout",l.staus,o,"\n"])),409===l.status&&toaster(o+"Conflict",3e3),301===l.status&&(toaster(o+" redirection",3e3),a(l.getResponseHeader("Location"),t,o)),l.ontimeout=function(e){toaster(o+"Time out",3e3),log_data.push(["timeout",o,"\n"])},0===l.status&&toaster(o+" status: "+l.status+l.getAllResponseHeaders(),3e3),200!==l.status&&log_data.push([l.getResponseHeader("Location"),l.staus,o,"\n"])}}function s(){$("div#navigation div").text(panels[0]),$.each(content_arr,function(e,t){var a=content_arr[e][4],s=content_arr[e][2],o=content_arr[e][5],r=content_arr[e][3],i=content_arr[e][0],n=content_arr[e][1],c=content_arr[e][6],l=content_arr[e][7],d=content_arr[e][8],u=content_arr[e][9],p=content_arr[e][10],f=" rss";if(!1===panels.includes(c)&&0!=c&&panels.push(c),"audio/mpeg"!=d&&"audio/aac"!=d||(f=" podcast"),!0===s.includes("https://www.youtube.com")&&(f=" youtube",s="https://www.youtube.com/embed/"+p+"?enablejsapi=1&autoplay=1"),"true"==y&&!0===C){var v=x.toLowerCase(),g=i.toLowerCase(),_=g.search(v);-1!=_&&(notify("Rss-Reader","The word/phrase you are looking for was found in one of the articles.",!1,!1),window.close())}if(!1===C){var m='<article class="'+c+f+' all" data-order = "'+a+'" data-link = "'+s+'" data-youtube-id= "'+p+'" data-download="'+l+'"data-audio-type="'+d+'"><div class="flex grid-col-10"><div class="podcast-icon"><img src="assets/image/podcast.png"></div><div class="youtube-icon"><img src="assets/image/youtube.png"></div></div><div class="channel">'+o+"</div><time>"+r+'</time><h1 class="title">'+i+'</h1><div class="summary">'+n+'<img src="'+u+'"></div></article>';$("div#news-feed-list").append(m),$("div#news-feed-list article:first").focus(),article_array=$("div#news-feed-list article")}}),r(),$("div#message-box").slideDown("400",function(){$("div#message-box").css("display","none")})}function o(){$("article").removeAttr("tabindex"),$("article").filter(":visible").each(function(e){$(this).prop("tabindex",e)}),article_array=$("article").filter(":visible"),$("body").find("article[tabindex = 0]").focus(),$("article:last").css("margin","0 0 30px 0")}function r(){var e=$("div#news-feed-list");e.find("article").sort(function(e,t){return+t.dataset.order-+e.dataset.order}).appendTo(e),article_array=$("div#news-feed-list article"),o()}function i(e,t){if("source-page"===window_status&&!1===T&&"on"===t)return T=!0,lock_screen("lock"),S=setInterval(function(){window.scrollBy(0,1)},e),void toaster("autoscroll on");!0!==T&&"off"!==t||(clearInterval(S),T=!1,lock_screen("unlock"))}function n(e){$("article").css("display","none"),$("article."+e).css("display","block"),$("div#app-panels article").find([tabindex="0"]).focus()}function c(e){"left"==e&&current_panel--,"right"==e&&current_panel++,current_panel%=panels.length,current_panel<0&&(current_panel+=panels.length),$("div#navigation div").text(panels[current_panel]),n(panels[current_panel]),o(),pos_focus=0}function l(e){var t=$("div#settings [tabIndex]");if("settings"==window_status){if("+1"==e&&pos_focus<t.length-1){pos_focus++;var a=t[pos_focus];a.focus();var s=$(":focus")[0].offsetTop+20;window.scrollTo({top:s,left:100,behavior:"smooth"})}if("-1"==e&&pos_focus>0){pos_focus--;a=t[pos_focus];a.focus();s=$(":focus")[0].offsetTop-20;window.scrollTo({top:s,left:100,behavior:"smooth"})}}if("article-list"==window_status){$(":focus")[0];if("+1"==e&&pos_focus<article_array.length-1&&(pos_focus++,pos_focus<=article_array.length)){s=$(":focus")[0].offsetTop+20;window.scrollTo({top:s,left:100,behavior:"smooth"});a=article_array[pos_focus];a.focus()}if("-1"==e&&pos_focus>0&&(pos_focus--,pos_focus>=0)){a=article_array[pos_focus];a.focus();s=$(":focus")[0].offsetTop;window.scrollTo({top:s+20,behavior:"smooth"})}}}function d(e,t){function a(e){if(e.lengthComputable){var t=e.loaded/e.total*100;toaster(t,1e3)}else toaster("loading....",1e3)}var s=new XMLHttpRequest({mozSystem:!0});s.open("GET",e,!0),s.withCredentials=!0,s.responseType="blob",toaster("download started",3e3),s.onload=function(){if(s.readyState===s.DONE&&200===s.status){var e=s.response,a=navigator.getDeviceStorage("music"),o=new Blob([e],{type:"audio/mpeg"});toaster("done",3e3);var r=a.addNamed(o,t+".mp3");r.onsuccess=function(){notify("RSS - Reader","successfully wrote on the storage area",!1,!1)},r.onerror=function(){alert("Unable to write the file: "+this.error)}}404===s.status&&toaster(" url not found"+s.getAllResponseHeaders(),3e3),301===s.status&&toaster(" redirection",3e3),0===s.status&&toaster(" status: "+s.status+s.getAllResponseHeaders(),3e4)},s.onerror=function(){toaster(" status: "+s.status+s.getAllResponseHeaders(),3e3)},s.addEventListener("progress",a),s.send(null)}function u(){var e=$("div#input-wrapper #search").val(),t=$("div#input-wrapper #time").val();""!=e||""!=t?(localStorage.setItem("search",e),localStorage.setItem("interval",t),localStorage.setItem("status",w),toaster("saved",3e3),""!=t&&m(t)):toaster("please fill in all fields",3e3)}function p(){navigator.spatialNavigationEnabled=!1,$("div#navigation").css("display","none"),$("div#news-feed").css("padding","5px 5px 30px 5px");var e=article_array[pos_focus];link_target=$(e).data("download"),link_type=$(e).data("audio-type"),$(":focus").hasClass("podcast")&&($(":focus").hasClass("audio-playing")?bottom_bar("pause","","download"):bottom_bar("play","","download")),($(":focus").hasClass("rss")||$(":focus").hasClass("youtube"))&&bottom_bar("","","visit source"),window.scrollTo(0,0);var t=$(":focus");$("article").css("display","none"),t.css("display","block"),$("div.summary").css("display","block"),$("div#bottom-bar").css("display","block"),$("div#settings").css("display","none"),window_status="single-article"}function f(){$("div#navigation").css("display","none"),$("div#news-feed").css("padding","5px 5px 30px 5px"),pos_focus=0,$("article").css("display","none"),$("div#settings").css("display","block"),bottom_bar("save","","back"),$("div#bottom-bar").css("display","block"),$("div#input-wrapper input#input-url").focus(),window_status="settings"}function v(){navigator.spatialNavigationEnabled=!1,$("div#source-page div#iframe-wrapper").removeClass("video-view"),$("div#navigation").css("display","block"),$("div#news-feed").css("padding","35px 5px 30px 5px"),$("article").css("display","block"),$("div.summary").css("display","none"),$("div#bottom-bar").css("display","block"),$("div#settings").css("display","none"),n(panels[current_panel]),o();var e=article_array[pos_focus];e.focus(),window.scrollTo(0,$(e).offset().top),$("div#source-page").css("display","none"),$("div#source-page iframe").attr("src",""),activity?bottom_bar("add","select",""):bottom_bar("settings","select",""),window_status="article-list",i(30,"off")}function g(){var e=article_array[pos_focus],t=$(e).data("link"),a=$(e).data("download"),s=$(e).find("h1.title").text();if(s=s.replace(/\s/g,"-"),$(":focus").hasClass("rss"))return $("div.summary").css("display","none"),$("div#source-page").css("display","block"),$("div#source-page iframe").attr("src",t),$("div#bottom-bar").css("display","none"),$("div#source-page div#iframe-wrapper").css("height","1000vh"),$("div#source-page iframe").css("height","1000vh"),void(window_status="source-page");if($(":focus").hasClass("youtube"))return $("div.summary").css("display","none"),$("div#source-page").css("display","block"),$("div#source-page iframe").attr("src",t),$("div#bottom-bar").css("display","none"),$("div#source-page div#iframe-wrapper").css("height","100vh"),$("div#source-page iframe").css("height","100vh"),$("div#source-page div#iframe-wrapper").addClass("video-view"),navigator.spatialNavigationEnabled=!0,window_status="source-page",void(player.src="");if($(":focus").hasClass("podcast")){var o=new Applait.Finder({type:"music",debugMode:!1});return o.on("empty",function(e){toaster("no sdcard found")}),o.search(s),o.on("fileFound",function(e,t,a){return toaster("The file is already available",3e3),!1}),void o.on("searchComplete",function(e,t){0==t&&d(a,s)})}}function _(){var e=navigator.mozAlarms.getAll();e.onsuccess=function(){this.result.forEach(function(e){navigator.mozAlarms.remove(e.id)}),console.log("operation successful:"+this.result.length+"alarms pending")},e.onerror=function(){console.log("An error occurred: "+this.error.name)}}function m(e){e=Number(e);let t=moment().add(e,"m").format("MMMM D, YYYY HH:mm:ss");new Date(t);var a=navigator.mozAlarms.add(t,"honorTimezone");a.onsuccess=function(){toaster("The alarm has been scheduled",1e4)},a.onerror=function(){alert("An error occurred: "+this.error.name)}}function h(e){switch(e.key){case"Enter":"article-list"==window_status&&p(),"settings"==window_status&&$("input[type=checkbox]").is(":focus")&&($("input[type=checkbox]").is(":checked")?($("input[type=checkbox]").prop("checked",!1),w="false",_()):($("input[type=checkbox]").prop("checked",!0),w="true"),u());break;case"ArrowLeft":"article-list"==window_status&&c("left"),"single-article"==window_status&&seeking("backward");break;case"ArrowRight":"article-list"==window_status&&c("right"),"single-article"==window_status&&seeking("forward");break;case"ArrowDown":l("+1"),!0===volume_status&&volume_control("down");break;case"ArrowUp":l("-1"),!0===volume_status&&volume_control("up");break;case"#":volume.requestShow(),volume_status=!0,navigator.spatialNavigationEnabled=!1;break;case"SoftLeft":if("article-list"==window_status)return void(activity?(toaster(source_array[0][0],3e3),add_source(source_array[0][0],5,"all",rss_title)):f());if("single-article"==window_status&&$(":focus").hasClass("podcast"))return void play_podcast();if("settings"==window_status)return void u();break;case"SoftRight":if("single-article"==window_status)return void g();if("settings"==window_status)return void v();break;case"Backspace":if(e.preventDefault(),"article-list"==window_status)return void window.close();if("settings"==window_status)return void v();if("single-article"==window_status)return void v();if("source-page"==window_status)return v(),void i(30,"off");break;case"2":i(30,"on")}}var w,y,b,x;e(),setTimeout(()=>{!1===activity&&(cache.getTime()?(t(),toaster("download",5e3)):(content_arr=cache.loadCache(),s(),toaster("load from cache",5e3)))},4e3),navigator.mozSetMessageHandler("activity",function(e){var t=e.source;if(activity=!0,"view"==t.name){for(;source_array.length>0;)source_array.pop();source_array.push([t.data.url,4,"","all"]),a(source_array[0][0],source_array[0][1],source_array[0][2],source_array[0][3]),bottom_bar("add","select","")}});var T=!1,S="";bottom_bar("settings","select","");var C=!1;navigator.mozSetMessageHandler("alarm",function(e){C=!0,_(),m(b)}),document.addEventListener("keydown",h),debug&&$(window).on("error",function(e){console.log("jQuery error event:",e);var t=e.originalEvent;console.log("original event:",t),t.message?alert("Error:\n\t"+t.message+"\nLine:\n\t"+t.lineno+"\nFile:\n\t"+t.filename):alert("Error:\n\t"+t.type+"\nElement:\n\t"+(t.srcElement||t.target))})});